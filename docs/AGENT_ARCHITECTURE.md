# Fortune Agent 架构设计

## 核心理念

**算命先生不是"生成"判决，而是从"命理书"中"选择"判词**

算命先生的本质是**分析和选择**，不是判决的生成。

## 系统架构

```
┌────────────────────┐
│      用户输入       │
│  （一句话 / 可空）  │
└─────────┬──────────┘
          │
          ▼
┌────────────────────┐
│   输入特征提取      │   ← 非语义！不"理解"
│────────────────────│
│ · 是否为空          │
│ · 字符长度区间      │
│ · 是否含问号        │
│ · 当前时间段        │
│ · 第几次算          │
└─────────┬──────────┘
          │
          ▼
┌────────────────────┐
│   命运状态机 FSM    │  ← 纯规则判断
│────────────────────│
│ 状态示例：          │
│ · 犹豫              │
│ · 已有答案          │
│ · 不甘心            │
│ · 深夜逃避          │
│ · 自欺              │
└─────────┬──────────┘
          │
          ▼
┌────────────────────┐
│    判词选择器       │  ← 不是生成！
│────────────────────│
│ 从【固定判词池】中  │
│ 选 1 条"母句"       │
└─────────┬──────────┘
          │
          ▼
┌────────────────────┐
│   LLM 微扰模块      │  ← 被阉割的 LLM
│────────────────────│
│ 只允许：            │
│ · 改语气            │
│ · 改节奏            │
│ 禁止：              │
│ · 新信息            │
│ · 解释 / 建议       │
└─────────┬──────────┘
          │
          ▼
┌────────────────────┐
│   命运判决输出      │
│   （只 1 句话）     │
└────────────────────┘
```

## 模块说明

### 1. InputFeatures - 输入特征

**非语义分析，只提取形式特征**

```python
class InputFeatures:
    - is_empty: 是否为空
    - char_length: 字符长度
    - has_question_mark: 是否含问号
    - hour: 当前时间（小时）
    - attempt_count: 第几次算
    
    派生特征：
    - is_midnight: 是否深夜（23点-5点）
    - is_dawn: 是否黎明（5点-7点）
    - length_category: 长度分类（empty/very_short/short/medium/long）
```

### 2. determine_state() - 命运状态机

**纯规则判断，不涉及语义理解**

状态定义：
- `HESITATING` - 犹豫：有问号 + 中等长度 + 多次询问
- `ALREADY_DECIDED` - 已有答案：无问号 + 短输入 + 多次
- `UNWILLING` - 不甘心：反复问（≥3次）+ 有问号
- `MIDNIGHT_ESCAPE` - 深夜逃避：深夜 + 短输入 + 多次
- `SELF_DECEPTION` - 自欺：空输入 + 多次
- `FIRST_TIME` - 第一次算：默认状态
- `REPEATED` - 反复算：反复问（≥3次）+ 无问号
- `EMPTY_HEART` - 空虚无问：空输入 + 第一次
- `SEEKING_CONFIRMATION` - 寻求确认：无问号 + 短输入 + 第一次

### 3. VerdictPool - 固定判词池

**"命理书"中的判词母句**

- 每个状态对应 5 条固定判词
- 支持中英文
- 判词特点：
  - 有态度（不温柔、不中性）
  - 有后果（明确的结局指向）
  - 高度针对性
  - 15-30字（中文）/ 10-20词（英文）

示例：
```python
HESITATING: [
    "犹豫时机已过，拖延的后果由你承担",
    "左右为难是因为答案早已明了，只是不愿承认",
    ...
]
```

### 4. select_verdict() - 判词选择器

**从判词池中选择，不生成**

选择策略：
- 使用哈希算法确保一致性
- 基于特征组合：attempt_count * 7 + char_length * 3 + hour * 5 + ...
- 相同输入特征 → 相同判词

### 5. LLMPerturbation - LLM 微扰模块

**被严格限制的 LLM**

允许的操作：
- ✓ 调整语序
- ✓ 改变停顿节奏（逗号、句号位置）
- ✓ 调整强硬或柔和的程度
- ✓ 使用同义替换（不改变含义）

严格禁止：
- ✗ 添加任何新信息
- ✗ 添加建议或解释
- ✗ 改变原句的核心含义
- ✗ 使用温柔或安慰性语气
- ✗ 添加形容词或副词（除非为了语气）

技术限制：
- `temperature=0.3` - 低温度，减少随机性
- `max_tokens=100` - 限制长度
- 如果 LLM 出错，直接返回母句

## 设计优势

### 1. 可控性
- 判词来自固定池，质量可控
- 不会产生不符合产品理念的内容

### 2. 一致性
- 相同输入特征得到相同判词（母句）
- 用户体验可预测

### 3. 效率
- 大部分逻辑是规则判断，速度快
- LLM 只用于微调语气，调用成本低

### 4. 可维护性
- 判词池独立维护，易于更新
- 状态机逻辑清晰，易于调整

### 5. 符合产品定位
- "命运判决" - 从命理书中找答案
- 不安慰、有态度、有后果
- 神秘感和仪式感

## 使用示例

```python
# 初始化
agent = FortuneAgent(llm_service)

# 执行算命
result = await agent.execute(
    question="我应该跳槽吗？",
    language='zh',
    enable_reasoning=False  # 是否返回推理过程
)

# 结果
{
    "result": "第一卦就是定局，别想着重来",  # 最终判词
    "state": "first_time"  # 判定的状态
}

# 如果 enable_reasoning=True，还会返回：
{
    "reasoning": {
        "features": {...},  # 提取的特征
        "state": "first_time",  # 判定的状态
        "mother_verdict": "第一卦就是定局，别想着重来",  # 母句
        "perturbation": "applied"  # 是否应用了微扰
    }
}
```

## 后续优化方向

1. **判词池扩展**：增加更多状态和判词
2. **选择策略优化**：引入更智能的选择算法
3. **状态机细化**：增加更多状态转移规则
4. **A/B 测试**：测试不同判词的用户反馈
5. **多轮对话**：支持连续对话的上下文

## 与旧版本对比

| 维度 | 旧版本 | 新版本 |
|------|--------|--------|
| 判词来源 | LLM 生成 | 固定池选择 |
| 问题分析 | 语义理解（关键词匹配） | 非语义特征 |
| 可控性 | 低（依赖 LLM） | 高（固定池） |
| 一致性 | 低（随机生成） | 高（哈希选择） |
| 速度 | 慢（完全依赖 LLM） | 快（规则+轻量LLM） |
| 成本 | 高（大量 token） | 低（少量 token） |
| 产品理念 | 偏离（AI助手感） | 契合（算命先生感） |

---

**核心价值观**：算命先生从命理书中选择判词，而不是生成判词。这是本质的区别。
